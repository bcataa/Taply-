<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Log in – Taply</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="supabase-config.js"></script>
  </head>
  <body class="login-page">
    <div class="login-bg"></div>

    <header class="login-header">
      <a href="landing.html" class="login-logo">Taply</a>
      <a href="landing.html" class="login-back">← Back</a>
    </header>

    <main class="login-main">
      <div class="login-card" id="loginCard">
        <div class="login-card-badge">Log in</div>
        <h1 class="login-title">Welcome back</h1>
        <p class="login-subtitle">Sign in to manage your link in bio.</p>

        <div class="auth-social-row" id="loginSocialRow">
          <button type="button" class="auth-btn-social auth-btn-google" id="loginGoogleBtn">
            <svg class="auth-btn-icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            Continue with Google
          </button>
        </div>
        <div class="auth-divider">
          <span>or continue with email</span>
        </div>

        <form class="login-form" id="loginForm">
          <label class="login-field">
            <span>Email</span>
            <input type="email" id="loginEmail" placeholder="email@example.com" required autocomplete="email" />
          </label>
          <label class="login-field">
            <span>Password</span>
            <input type="password" id="loginPassword" placeholder="••••••••" required autocomplete="current-password" />
            <a href="forgot-password.html" class="login-forgot-link">Forgot password?</a>
          </label>
          <p class="login-error" id="loginError"></p>
          <p class="login-resend-wrap" id="loginResendWrap" hidden>
            <button type="button" class="login-resend-link" id="loginResendBtn">Didn’t get the email? Resend confirmation link</button>
          </p>
          <p class="login-success" id="loginSuccess" hidden></p>
          <button type="submit" class="login-btn" id="loginBtn">Sign in</button>
        </form>

        <p class="login-footer-text">
          Don’t have an account?
          <a href="register.html">Sign up free</a>
        </p>
      </div>
    </main>

    <footer class="login-page-footer">
      <p>© Taply · <a href="privacy.html">Privacy</a> · 100% free</p>
    </footer>

    <script>
      (function () {
        var form = document.getElementById("loginForm");
        var emailInput = document.getElementById("loginEmail");
        var passwordInput = document.getElementById("loginPassword");
        var errorEl = document.getElementById("loginError");
        var btn = document.getElementById("loginBtn");

        // Pre-fill email from ?email= in URL (landing page shortcut)
        try {
          var params = new URLSearchParams(window.location.search);
          var emailParam = params.get("email");
          if (emailParam && emailInput) {
            emailInput.value = emailParam;
            emailInput.focus();
          }
        } catch (e) {}

        function useSupabase() {
          return window.TaplySupabase && window.TaplySupabase.url && window.TaplySupabase.anonKey && window.supabase;
        }
        (function () {
          if (!useSupabase()) {
            var sr = document.getElementById("loginSocialRow");
            var div = document.getElementById("loginAuthDivider");
            if (sr) sr.style.display = "none";
            if (div) div.style.display = "none";
          }
        })();
        function loginErrorMsg(msg) {
          if (!msg) return "Connection error.";
          var m = msg.toLowerCase();
          if (m.indexOf("invalid login credentials") !== -1) return "Invalid email or password.";
          if (m.indexOf("email not confirmed") !== -1) return "Confirm your email first. Check your inbox (and spam).";
          if (m.indexOf("invalid") !== -1 && m.indexOf("email") !== -1) return "Use the email address you signed up with.";
          if (m.indexOf("rate limit") !== -1 || m.indexOf("too many") !== -1) return "Too many attempts. Wait 1–2 minutes and try again.";
          return msg;
        }

        if (form) {
          form.addEventListener("submit", function (e) {
            e.preventDefault();
            var email = (emailInput && emailInput.value) ? emailInput.value.trim() : "";
            var password = passwordInput ? passwordInput.value : "";
            if (!email || !password) {
              if (errorEl) errorEl.textContent = "Enter email and password.";
              return;
            }
            if (errorEl) errorEl.textContent = "";
            var resendWrap = document.getElementById("loginResendWrap");
            var successEl = document.getElementById("loginSuccess");
            if (resendWrap) resendWrap.hidden = true;
            if (successEl) successEl.hidden = true;
            if (btn) { btn.disabled = true; btn.textContent = "Signing in…"; }

            if (useSupabase()) {
              var supabase = window.supabase.createClient(window.TaplySupabase.url, window.TaplySupabase.anonKey);
              supabase.auth.signInWithPassword({ email: email, password: password })
                .then(function (result) {
                  if (result.error) {
                    var msg = result.error.message || "";
                    if (errorEl) errorEl.textContent = loginErrorMsg(msg);
                    if (btn) { btn.disabled = false; btn.textContent = "Sign in"; }
                    var resendWrap = document.getElementById("loginResendWrap");
                    var successEl = document.getElementById("loginSuccess");
                    if (resendWrap) resendWrap.hidden = msg.toLowerCase().indexOf("email not confirmed") === -1;
                    if (successEl) successEl.hidden = true;
                    return;
                  }
                  window.location.replace(window.location.pathname.replace(/login\.html$/, "index.html") || "index.html");
                })
                .catch(function () {
                  if (errorEl) errorEl.textContent = "Connection error. Check supabase-config.js (URL and anon key).";
                  if (btn) { btn.disabled = false; btn.textContent = "Sign in"; }
                  var r = document.getElementById("loginResendWrap"); if (r) r.hidden = true;
                });
              return;
            }

            var apiBase = window.location.origin;
            fetch(apiBase + "/api/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email: email, password: password })
            })
              .then(function (r) { return r.json().then(function (data) { return { ok: r.ok, data: data }; }); })
              .then(function (result) {
                if (result.ok) {
                  if (result.data.token) {
                    try { localStorage.setItem("taply_token", result.data.token); } catch (err) {}
                  }
                  window.location.replace(window.location.pathname.replace(/login\.html$/, "index.html") || "index.html");
                } else {
                  if (errorEl) errorEl.textContent = result.data.error || "Invalid email or password.";
                  if (btn) { btn.disabled = false; btn.textContent = "Sign in"; }
                }
              })
              .catch(function () {
                var isLocal = window.location.protocol === "file:" || window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";
                if (errorEl) errorEl.textContent = isLocal ? "Connection error. Start the server (double-click Taply.command or ./start.sh), then open: http://localhost:8001/login.html" : "Connection error. Please check your internet and try again.";
                if (btn) { btn.disabled = false; btn.textContent = "Sign in"; }
              });
          });
        }

        function doSocialLogin(provider) {
          if (!useSupabase()) return;
          var redirectTo = window.location.origin + (window.location.pathname.replace(/\/[^/]*$/, "") || "") + "/index.html";
          var supabase = window.supabase.createClient(window.TaplySupabase.url, window.TaplySupabase.anonKey);
          supabase.auth.signInWithOAuth({ provider: provider, options: { redirectTo: redirectTo } }).then(function (r) {
            if (r.error) {
              if (errorEl) errorEl.textContent = r.error.message || "Connection error.";
              return;
            }
            if (r.data && r.data.url) window.location.href = r.data.url;
          });
        }
        var googleBtn = document.getElementById("loginGoogleBtn");
        if (googleBtn) googleBtn.addEventListener("click", function () { doSocialLogin("google"); });

        var resendBtn = document.getElementById("loginResendBtn");
        if (resendBtn) {
          resendBtn.addEventListener("click", function () {
            var email = (emailInput && emailInput.value) ? emailInput.value.trim() : "";
            if (!email || !useSupabase()) return;
            var supabase = window.supabase.createClient(window.TaplySupabase.url, window.TaplySupabase.anonKey);
            resendBtn.disabled = true;
            supabase.auth.resend({ type: "signup", email: email }).then(function (r) {
              var successEl = document.getElementById("loginSuccess");
              var resendWrap = document.getElementById("loginResendWrap");
              if (r.error && successEl) {
                successEl.textContent = r.error.message || "Error resending.";
                successEl.hidden = false;
                successEl.style.color = "var(--error, #e57373)";
              } else if (successEl) {
                successEl.textContent = "Link resent. Check your email (and spam).";
                successEl.style.color = "rgba(255,255,255,0.9)";
                successEl.hidden = false;
                if (resendWrap) resendWrap.hidden = true;
              }
              resendBtn.disabled = false;
            }).catch(function () {
              resendBtn.disabled = false;
            });
          });
        }
      })();
    </script>
  </body>
</html>
