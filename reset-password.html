<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>New password – Taply</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="supabase-config.js"></script>
  </head>
  <body class="login-page">
    <div class="login-bg"></div>
    <header class="login-header">
      <a href="/landing" class="login-logo">Taply</a>
      <a href="/login" class="login-back">← Login</a>
    </header>
    <main class="login-main">
      <div class="login-card">
        <div class="login-card-badge">New password</div>
        <h1 class="login-title">Set new password</h1>
        <p class="login-subtitle">Choose a new password (at least 6 characters).</p>
        <p class="login-error" id="resetInvalidLink" style="display:none;">Invalid or expired link. <a href="forgot-password.html" style="color:#a78bfa;text-decoration:underline;">Request a new link</a>.</p>
        <form class="login-form" id="resetForm">
          <label class="login-field">
            <span>New password</span>
            <input type="password" id="resetPassword" placeholder="••••••••" required minlength="6" autocomplete="new-password" />
          </label>
          <label class="login-field">
            <span>Confirm password</span>
            <input type="password" id="resetPasswordConfirm" placeholder="••••••••" required minlength="6" autocomplete="new-password" />
          </label>
          <p class="login-error" id="resetError"></p>
          <p class="login-success" id="resetSuccess" hidden></p>
          <button type="submit" class="login-btn" id="resetBtn">Save password</button>
        </form>
        <p class="login-footer-text">
          <a href="/login">Back to login</a>
        </p>
      </div>
    </main>
    <footer class="login-page-footer">
      <p>© Taply · 100% free</p>
    </footer>
    <script>
      (function () {
        var form = document.getElementById("resetForm");
        var passInput = document.getElementById("resetPassword");
        var passConfirmInput = document.getElementById("resetPasswordConfirm");
        var errorEl = document.getElementById("resetError");
        var successEl = document.getElementById("resetSuccess");
        var btn = document.getElementById("resetBtn");
        function useSupabase() {
          return window.TaplySupabase && window.TaplySupabase.url && window.TaplySupabase.anonKey && window.supabase;
        }
        (function checkRecoveryLink() {
          var hash = window.location.hash || "";
          var hasToken = hash.indexOf("access_token=") !== -1 || hash.indexOf("type=recovery") !== -1;
          if (!hasToken && useSupabase()) {
            var supabase = window.supabase.createClient(window.TaplySupabase.url, window.TaplySupabase.anonKey);
            supabase.auth.getSession().then(function (r) {
              var session = r.data && r.data.session;
              if (!session) {
                var invalidEl = document.getElementById("resetInvalidLink");
                var formEl = document.getElementById("resetForm");
                var footerEl = document.querySelector(".login-footer-text");
                if (invalidEl) invalidEl.style.display = "block";
                if (formEl) formEl.style.display = "none";
                if (footerEl) footerEl.style.display = "block";
              }
            });
          }
        })();
        if (form) {
          form.addEventListener("submit", function (e) {
            e.preventDefault();
            var pass = passInput ? passInput.value : "";
            var passConfirm = passConfirmInput ? passConfirmInput.value : "";
            if (!pass || pass.length < 6) {
              if (errorEl) errorEl.textContent = "Password must be at least 6 characters.";
              return;
            }
            if (pass !== passConfirm) {
              if (errorEl) errorEl.textContent = "Passwords don’t match.";
              return;
            }
            if (errorEl) errorEl.textContent = "";
            if (successEl) successEl.hidden = true;
            if (btn) { btn.disabled = true; btn.textContent = "Saving…"; }
            if (!useSupabase()) {
              if (errorEl) errorEl.textContent = "Password reset is only available with Supabase.";
              if (btn) { btn.disabled = false; btn.textContent = "Save password"; }
              return;
            }
            var supabase = window.supabase.createClient(window.TaplySupabase.url, window.TaplySupabase.anonKey);
            supabase.auth.updateUser({ password: pass })
              .then(function (r) {
                if (r.error) {
                  var errMsg = (r.error.message || "").toLowerCase();
                  if (errMsg.indexOf("session") !== -1 || errMsg.indexOf("expired") !== -1 || errMsg.indexOf("invalid") !== -1) {
                    if (errorEl) errorEl.innerHTML = "Link expired or invalid. <a href=\"forgot-password.html\">Request a new link</a>.";
                  } else {
                    if (errorEl) errorEl.textContent = r.error.message || "Error. Try again.";
                  }
                  if (btn) { btn.disabled = false; btn.textContent = "Save password"; }
                  return;
                }
                if (successEl) {
                  successEl.textContent = "Password updated. Redirecting to login…";
                  successEl.hidden = false;
                }
                setTimeout(function () {
                  window.location.replace(window.location.origin + "/login");
                }, 1500);
              })
              .catch(function () {
                if (errorEl) errorEl.textContent = "Error. Try again or request a new reset link.";
                if (btn) { btn.disabled = false; btn.textContent = "Save password"; }
              });
          });
        }
      })();
    </script>
  </body>
</html>
