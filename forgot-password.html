<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reset password – Taply</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="/supabase-config.js"></script>
  </head>
  <body class="login-page">
    <div class="login-bg"></div>
    <header class="login-header">
      <a href="/landing" class="login-logo"><img src="/favicon.svg" alt="" class="login-logo-img" width="28" height="28" />Taply</a>
      <a href="/login" class="login-back">← Back to login</a>
    </header>
    <main class="login-main">
      <div class="login-card">
        <div class="login-card-badge">Reset password</div>
        <h1 class="login-title">Forgot password?</h1>
        <p class="login-subtitle">Enter your account email and we’ll send you a link to set a new password.</p>
        <p class="login-hint" style="font-size:13px;color:rgba(255,255,255,0.5);margin:-8px 0 16px;">Check spam too. One link is enough; only resend if you didn’t receive it. After sending, the button is disabled for 5 minutes.</p>
        <form class="login-form" id="forgotForm">
          <label class="login-field">
            <span>Email</span>
            <input type="email" id="forgotEmail" placeholder="email@example.com" required autocomplete="email" />
          </label>
          <p class="login-error" id="forgotError"></p>
          <p class="login-success" id="forgotSuccess" hidden></p>
          <button type="submit" class="login-btn" id="forgotBtn">Send reset link</button>
        </form>
        <p class="login-footer-text">
          <a href="/login">Back to login</a>
        </p>
      </div>
    </main>
    <footer class="login-page-footer">
      <p>© Taply · 100% free</p>
    </footer>
    <script>
      (function () {
        var form = document.getElementById("forgotForm");
        var emailInput = document.getElementById("forgotEmail");
        var errorEl = document.getElementById("forgotError");
        var successEl = document.getElementById("forgotSuccess");
        var btn = document.getElementById("forgotBtn");
        function useSupabase() {
          return window.TaplySupabase && window.TaplySupabase.url && window.TaplySupabase.anonKey && window.supabase;
        }
        var COOLDOWN_KEY = "taply_forgot_cooldown";
        var COOLDOWN_SEC = 300;
        function cooldownLeft() {
          try {
            var until = parseInt(sessionStorage.getItem(COOLDOWN_KEY), 10);
            if (!until) return 0;
            var left = Math.ceil((until - Date.now()) / 1000);
            return left > 0 ? left : 0;
          } catch (e) { return 0; }
        }
        function startCooldown() {
          try {
            sessionStorage.setItem(COOLDOWN_KEY, String(Date.now() + COOLDOWN_SEC * 1000));
          } catch (e) {}
        }
        function tickCooldown() {
          var left = cooldownLeft();
          if (left <= 0) {
            if (btn) { btn.disabled = false; btn.textContent = "Send reset link"; }
            return;
          }
          if (btn) { btn.disabled = true; btn.textContent = "You can send again in " + left + " s"; }
          setTimeout(tickCooldown, 1000);
        }
        (function initCooldown() {
          if (cooldownLeft() > 0) {
            if (btn) btn.disabled = true;
            tickCooldown();
          }
        })();
        if (form) {
          form.addEventListener("submit", function (e) {
            e.preventDefault();
            if (cooldownLeft() > 0) return;
            var email = (emailInput && emailInput.value) ? emailInput.value.trim() : "";
            if (!email) {
              if (errorEl) errorEl.textContent = "Enter your email address.";
              return;
            }
            if (errorEl) errorEl.textContent = "";
            if (successEl) successEl.hidden = true;
            if (btn) { btn.disabled = true; btn.textContent = "Sending…"; }
            if (!useSupabase()) {
              if (errorEl) errorEl.textContent = "Password reset is only available with Supabase. Configure supabase-config.js.";
              if (btn) { btn.disabled = false; btn.textContent = "Send reset link"; }
              return;
            }
            var supabase = window.supabase.createClient(window.TaplySupabase.url, window.TaplySupabase.anonKey);
            var basePath = (window.location.pathname || "/").replace(/\/[^/]*$/, "") || "/";
            if (basePath !== "/") basePath = basePath + "/";
            var redirectTo = window.location.origin + basePath + "reset-password.html";
            function forgotErrorMsg(msg) {
              if (!msg) return "Error sending.";
              var m = (msg + "").toLowerCase();
              if (m.indexOf("rate limit") !== -1 || m.indexOf("too many") !== -1) return "Too many attempts. Supabase limit resets after a few hours — try again later. If you use Custom SMTP (Resend), increase \"Email sent\" in Supabase → Authentication → Rate limits.";
              if (m.indexOf("sending recovery") !== -1 || m.indexOf("error sending") !== -1) return "Error sending email. With Gmail SMTP: Sender email and Username = your Gmail, Password = App Password. With Resend: Sender = onboarding@resend.dev, Username = resend, Password = API Key. Check Supabase → Authentication → Email and Save.";
              return msg;
            }
            supabase.auth.resetPasswordForEmail(email, { redirectTo: redirectTo })
              .then(function (r) {
                startCooldown();
                if (r.error) {
                  if (errorEl) errorEl.textContent = forgotErrorMsg(r.error.message);
                  tickCooldown();
                  return;
                }
                if (errorEl) errorEl.textContent = "";
                if (successEl) {
                  successEl.textContent = "Link sent. Check your email (and spam) and click the link to set your new password.";
                  successEl.hidden = false;
                }
                tickCooldown();
              })
              .catch(function () {
                startCooldown();
                if (errorEl) errorEl.textContent = "Connection error.";
                tickCooldown();
              });
          });
        }
      })();
    </script>
  </body>
</html>
